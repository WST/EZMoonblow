# Development web server: Nginx + PHP-FPM.
#
# Replaces the single-threaded `php -S` built-in server.
# Handles concurrent requests (admin panel + SSE streaming + backtest API).
#
# Requires MySQL from compose.yml to be running:
#   docker compose up -d mysql
#
# Usage:
#   docker compose -f docker-compose.dev.yml up --build
#   # or via tasks/dev/run-server
#
# The web UI is available at http://127.0.0.1:9090

services:
  php:
    build:
      context: ..
      dockerfile: dev/Dockerfile
      args:
        HOST_UID: ${HOST_UID:-1000}
        HOST_GID: ${HOST_GID:-1000}
    container_name: ezmoonblow-dev-php
    volumes:
      - .:/app
    working_dir: /app
    environment:
      - TZ=Asia/Yerevan
      - IZZY_DB_HOST=ezmoonblow-mysql
      - IZZY_DB_PORT=3306
    networks:
      - dev-net
      - ezmoonblow-network

  nginx:
    image: nginx:alpine
    container_name: ezmoonblow-dev-nginx
    ports:
      - "9090:80"
    volumes:
      - ./docker/dev/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./web:/app/web:ro
      - ./charts:/app/charts:ro
      - ./extras:/app/extras:ro
    depends_on:
      - php
    networks:
      - dev-net

networks:
  dev-net:
    driver: bridge
  ezmoonblow-network:
    external: true
    name: ezmoonblow_ezmoonblow-network