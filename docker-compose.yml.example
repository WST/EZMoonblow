# EZMoonblow Docker Compose configuration.

services:
  # MySQL database server.
  mysql:
    image: mysql:8.0
    container_name: ezmoonblow-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: izzy_php
      MYSQL_USER: izzy
      MYSQL_PASSWORD: izzy123
    ports:
      - "23306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - ezmoonblow-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootpassword"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Database migrations service.
  # This service runs migrations once before other services start.
  migrator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ezmoonblow-migrator
    restart: "no"
    command: /app/tasks/docker/run-migrations.sh
    volumes:
      - ./config:/app/config:ro
      - ./migrations:/app/migrations:ro
      - migration_marker:/app/migration_marker
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - ezmoonblow-network
    environment:
      - TZ=Asia/Yerevan
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Trading component.
  trader:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ezmoonblow-trader
    restart: "no"
    command: ["/app/tasks/docker/wait-for-migrations.sh", "/app/trader.php"]
    volumes:
      - ./config:/app/config:ro
      - ./logs:/app/logs
      - ./charts:/app/charts
      - ./rrd:/app/rrd
      - ./cache:/app/cache
      - migration_marker:/app/migration_marker
    depends_on:
      mysql:
        condition: service_healthy
      migrator:
        condition: service_completed_successfully
    networks:
      - ezmoonblow-network
    environment:
      - TZ=Asia/Yerevan
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Analysis component.
  analyzer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ezmoonblow-analyzer
    restart: "no"
    command: ["/app/tasks/docker/wait-for-migrations.sh", "/app/analyzer.php"]
    volumes:
      - ./config:/app/config:ro
      - ./logs:/app/logs
      - ./charts:/app/charts
      - ./rrd:/app/rrd
      - ./cache:/app/cache
      - migration_marker:/app/migration_marker
    depends_on:
      mysql:
        condition: service_healthy
      migrator:
        condition: service_completed_successfully
    networks:
      - ezmoonblow-network
    environment:
      - TZ=Asia/Yerevan
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Notifications component.
  notifier:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ezmoonblow-notifier
    restart: "no"
    command: ["/app/tasks/docker/wait-for-migrations.sh", "/app/notifier.php"]
    volumes:
      - ./config:/app/config:ro
      - ./logs:/app/logs
      - ./charts:/app/charts
      - ./rrd:/app/rrd
      - ./cache:/app/cache
      - migration_marker:/app/migration_marker
    depends_on:
      mysql:
        condition: service_healthy
      migrator:
        condition: service_completed_successfully
    networks:
      - ezmoonblow-network
    environment:
      - TZ=Asia/Yerevan
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Web interface — PHP-FPM backend.
  # Handles concurrent requests (admin panel + SSE streaming + backtest API).
  web-php:
    build:
      context: .
      dockerfile: docker/web/Dockerfile
    container_name: ezmoonblow-web-php
    restart: "no"
    command: ["/app/tasks/docker/wait-for-migrations.sh", "php-fpm"]
    volumes:
      - ./config:/app/config:ro
      - ./logs:/app/logs
      - ./charts:/app/charts
      - ./rrd:/app/rrd
      - ./cache:/app/cache
      - ./templates:/app/templates:ro
      - migration_marker:/app/migration_marker
    depends_on:
      mysql:
        condition: service_healthy
      migrator:
        condition: service_completed_successfully
    networks:
      - ezmoonblow-network
    environment:
      - TZ=Asia/Yerevan
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Web interface — Nginx frontend.
  web-nginx:
    image: nginx:alpine
    container_name: ezmoonblow-web-nginx
    restart: "no"
    ports:
      - "9090:80"
    volumes:
      - ./docker/web/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./web:/app/web:ro
      - ./charts:/app/charts:ro
      - ./extras:/app/extras:ro
    depends_on:
      - web-php
    networks:
      - ezmoonblow-network

volumes:
  mysql_data:
    driver: local
  migration_marker:
    driver: local

networks:
  ezmoonblow-network:
    driver: bridge

